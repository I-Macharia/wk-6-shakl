name: SonarCloud analysis and create Jira issues

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run SonarCloud analysis
        uses: SonarSource/sonarcloud-github-action@v1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=I-Macharia_wk-6-shakl
            -Dsonar.organization=i-macharia
            -Dsonar.sources=.

  create-jira-issues:
    needs: analyze
    runs-on: ubuntu-latest
    steps:
      - name: Setup tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl python3

      - name: Fetch Sonar issues and create Jira issues
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: I-Macharia_wk-6-shakl
          JIRA_HOST: ${{ secrets.JIRA_HOST }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
        run: |
          set -euo pipefail

          SONAR_API="https://sonarcloud.io/api/issues/search?componentKeys=${SONAR_PROJECT_KEY}&resolved=false&types=VULNERABILITY,BUG,CODE_SMELL&ps=500"
          echo "Calling SonarCloud API for project ${SONAR_PROJECT_KEY}"
          issues_json=$(curl -s -u "${SONAR_TOKEN}:" "${SONAR_API}")

          total=$(echo "$issues_json" | jq -r '.total')
          echo "Found $total unresolved Sonar issues"

          if [ "$total" -eq 0 ]; then
            echo "No unresolved issues to create in Jira. Exiting."
            exit 0
          fi

          echo "$issues_json" | jq -c '.issues[]' | while IFS= read -r issue; do
            issue_key=$(echo "$issue" | jq -r '.key')
            rule=$(echo "$issue" | jq -r '.rule')
            severity=$(echo "$issue" | jq -r '.severity')
            comp=$(echo "$issue" | jq -r '.component')
            file=$(echo "$issue" | jq -r '.component' | sed 's/.*://')
            line=$(echo "$issue" | jq -r '.line // "n/a"')
            message=$(echo "$issue" | jq -r '.message' | sed 's/"/\\"/g')
            sonar_link="https://sonarcloud.io/project/issues?id=${SONAR_PROJECT_KEY}&open=${issue_key}"

            summary="SonarCloud ${severity}: ${rule} in ${file}:${line} (${issue_key})"
            description="SonarCloud issue: ${issue_key}\n\nRule: ${rule}\nSeverity: ${severity}\nComponent: ${comp}\nLine: ${line}\n\nMessage:\n${message}\n\nSonar link: ${sonar_link}"

            # URL encode the issue key for JQL query using printf
            jql=$(printf 'summary ~~ "%s"' "$issue_key" | python3 -c "import sys, urllib.parse; print(urllib.parse.quote(sys.stdin.read()))")

            search_url="https://${JIRA_HOST}/rest/api/3/search?jql=${jql}&fields=key"
            existing=$(curl -s -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" -H "Accept: application/json" "${search_url}")

            existing_total=$(echo "$existing" | jq -r '.total // 0')
            if [ "$existing_total" != "0" ]; then
              echo "Jira issue already exists for Sonar issue ${issue_key}; skipping creation."
              continue
            fi

            payload=$(jq -n --arg proj "${JIRA_PROJECT_KEY}" \
                            --arg summ "$summary" \
                            --arg desc "$description" \
                            '{fields: {project: {key: $proj}, summary: $summ, description: $desc, issuetype: {name: "Bug"}}}')

            echo "Creating Jira issue for Sonar issue ${issue_key}"
            create_resp=$(curl -s -w "\n%{http_code}" -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
              -X POST -H "Content-Type: application/json" \
              --data "$payload" \
              "https://${JIRA_HOST}/rest/api/3/issue")
            http_code=$(echo "$create_resp" | tail -n1)
            body=$(echo "$create_resp" | sed '$d')

            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
              jira_key=$(echo "$body" | jq -r '.key')
              echo "Created Jira issue ${jira_key} for Sonar issue ${issue_key}"
            else
              echo "Failed to create Jira issue for ${issue_key}: HTTP ${http_code}"
              echo "$body"
            fi
          done
